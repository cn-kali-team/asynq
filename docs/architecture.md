# Asynq Rust 架构设计文档

## 概述

Asynq Rust 版本是基于 [hibiken/asynq](https://github.com/hibiken/asynq) Go 版本的 Rust 重写，保持了原有的核心设计理念，同时充分利用
Rust 的特性来提供更好的性能和安全性。

## 设计原则

1. **类型安全**: 充分利用 Rust 的类型系统确保编译时安全
2. **内存安全**: 避免常见的内存错误，如空指针和缓冲区溢出
3. **并发安全**: 使用 Rust 的所有权系统确保线程安全
4. **零成本抽象**: 提供高级抽象的同时保持性能
5. **可扩展性**: 模块化设计便于扩展和维护

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │   Producer  │  │   Consumer  │  │   Manager   │           │
│  │    应用      │  │    应用     │  │    应用      │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      Asynq 库                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │   Client    │  │   Server    │  │  Inspector  │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 Broker 抽象层                            │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      存储层                                  │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │    Redis    │  │   Cluster   │                           │
│  │   单机模式   │  │   集群模式   │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 任务系统 (Task System)

#### Task 结构

```rust
pub struct Task {
    pub task_type: String,    // 任务类型
    pub payload: Vec<u8>,     // 任务负载
    pub options: TaskOptions, // 任务选项
}
```

#### TaskState 状态机

```
   创建
    ↓
  Pending ←─────┐
    ↓          │
  Active       │
    ↓          │
  [成功]       │ [失败]
    ↓          ↓
  Completed   Retry ←─┐
               ↓      │ [重试次数未达上限]
             [重试]  │
               ↓──────┘
            Archived [重试次数达上限]
```

### 2. 客户端和服务器架构

客户端负责任务入队，服务器负责任务处理，通过 Broker 抽象层与 Redis 交互。

### 3. Redis 数据结构映射

```
Redis 数据结构                   Asynq 概念
├── asynq:queues:{queue}         → 等待队列 (List)
├── asynq:active:{queue}         → 活跃任务 (Hash)
├── asynq:scheduled:{queue}      → 调度任务 (Sorted Set)
├── asynq:retry:{queue}          → 重试任务 (Sorted Set)
├── asynq:archived:{queue}       → 归档任务 (Sorted Set)
├── asynq:completed:{queue}      → 完成任务 (Sorted Set)
├── asynq:servers:{server_id}    → 服务器信息 (Hash)
└── asynq:unique:{key}           → 唯一性锁 (String)
```

## 特性实现

### 错误处理

- 完整的错误类型体系
- 支持错误链和上下文
- 区分可重试和不可重试错误

### 并发安全

- 所有共享状态使用 `Arc` 和 `Mutex`
- Handler 必须实现 `Send + Sync`
- 使用 `tokio` 异步运行时

### 配置管理

- 类型安全的配置选项
- 验证和默认值支持
- 支持多种 Redis 连接模式

这个架构确保了 Asynq Rust 版本的高性能、可靠性和可维护性。